# Common Profile
#------------------------------------------------
# Source this file from .bashrc and .zshrc


# Server ID
#------------------------------------------------

#Set the computer name here
FILE=~/.server_name.txt

if [ ! -f "$FILE" ]; then
  echo "Insert a server name in ~/.server_name.txt" > ~/.server_name.txt
else
  # NO-OP
  :
fi

server_name=$(cat ~/.server_name.txt )

# Join Message
echo -e "\e[1;31m$server_name\e[0m"

# Set Windows Terminal Tab Name
echo -ne "\033]0;$server_name\a"

# Environment Variables
#------------------------------------------------

export EDITOR='nano'

# Certificates
export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt

# Docker
export STACK_DEPLOY_DETACHED=true


# PATH
export PATH=$PATH:~/.local/bin

# UV
# export UV_NO_SYNC=1

# Load secrets
source ~/.shell_secrets


# General Aliases
#------------------------------------------------
alias path='sed "s/:/\n/g" <<< "$PATH"'

alias editprofile='nano ~/.common_profile'
alias editcommon='editprofile'

# GPU
alias nvitop="uvx nvitop"

# Exa
alias ls="eza --icons --group-directories-first"
alias ll="eza -lah --icons --group-directories-first --long --header --git --group"

# Browsing
alias grep='grep --color'

alias unrar-find='unrar e -r -o- *.rar ./'

# General Functions
#------------------------------------------------

function cls {
    clear && printf '\033c'
}

# Docker
#------------------------------------------------

alias dockerup='docker compose up -d --remove-orphans && docker compose ps && dtop'
alias ddown='docker compose down'
alias dtop='docker ps -q | xargs  docker stats --no-stream && echo "" && echo "" &&  docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"'
alias logd='docker logs -tf --tail="200"'
alias ctop='docker run --rm -ti  --volume /var/run/docker.sock:/var/run/docker.sock:ro  quay.io/vektorlab/ctop:latest'

function dnode(){
	local input_command="$1"
	
	if [[ $input_command == 'labels' ]]; then
		docker node ls -q | xargs docker node inspect   -f '{{ .ID }} [{{ .Description.Hostname }}]: {{ range $k, $v := .Spec.Labels }}{{ $k }}={{ $v }} {{end}}'
	fi

	bash ~/yadm/scripts/docker-node-labels.sh
}

# Development
#------------------------------------------------

alias semvar='semantic-release'

alias semvar-print='semantic-release -v --noop version'

alias act='gh act'

alias ansible-start="docker run -it --rm -w /work -v `pwd`:/work -v $HOME/.ssh/id_ed25519:/root/.ssh/id_ed25519:ro --entrypoint=/bin/sh docker.io/devture/ansible:2.13.6-r0-3"

# Python
#------------------------------------------------

# Virtual Environment
alias venv='source .venv/bin/activate'

uv-list() {
  if [ -z "$1" ]; then
    echo -e "\033[1;31mUSAGE: uv-list <PACKAGE>\033[0m"
    return 1
  fi

  local pkg="$1"
  echo -e "\n\033[1;34m----- PACKAGES NEEDING '$pkg' -----\033[0m\n"
  uv tree --invert --package "$pkg" || echo "No packages depend on '$pkg'."

  echo -e "\n\n\033[1;32m----- '$pkg' DEPENDENCIES -----\033[0m\n"
  uv tree --package "$pkg" || echo "No dependencies found for '$pkg'."
  echo -e "\n\n"
}

# Node
#------------------------------------------------
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"


# SSH
#------------------------------------------------

source ~/yadm/scripts/check_and_run_keychain.sh

alias add-ssh='ssh-add -t 48h ~/.ssh/id_ed25519'


# Git
#------------------------------------------------
alias pre-commit='uvx pre-commit'

alias readme='reporoot && pwd && nano --view README.md'

alias gitgraph="git -c log.showSignature=false log --oneline --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)%Creset' --abbrev-commit"
alias gitlog='git log --decorate --all --show-pulls --show-signature --max-count 3 --abbrev-commit'

function gitpush() {
	git push $1 $2
	git log --decorate --all --show-pulls --show-signature --max-count 1
}

function gitcleantags() {
    local TAGS
    TAGS=$(git tag -l "*-main*" "*-rc*" "*-beta*")

    if [ -z "$TAGS" ]; then
        echo 'No tags matching "*-main*" "*-rc*" "*-beta*" found.'
        return
    fi

    echo 'The following tags match "*-main*" "*-rc*" "*-beta*":'
    echo "$TAGS"
    echo -n "Delete these tags locally? [y/N]: "
    read -r CONFIRM_LOCAL

    if [[ "$CONFIRM_LOCAL" =~ ^[Yy]$ ]]; then
        echo "$TAGS" | xargs -n 1 git tag -d
    else
        echo "Skipped local deletion."
    fi

    echo -n "Also delete these tags from 'origin'? [y/N]: "
    read -r CONFIRM_ORIGIN

    if [[ "$CONFIRM_ORIGIN" =~ ^[Yy]$ ]]; then
        echo "$TAGS" | xargs -n 1 -I {} git push origin :refs/tags/{}
        if git remote | grep -q "^warehouse$"; then
            echo "Deleting tags from 'warehouse' as well..."
            echo "$TAGS" | xargs -n 1 -I {} git push warehouse :refs/tags/{}
        fi
    else
        echo "Skipped remote deletion."
    fi
}

function reporoot {
  # Copyright 2009 Daniel Jackoway
  # MIT License
  while [ ! -d .git -a ! -f 'README.md' -a `pwd` != "/" ]
  do
      cd ".."; 
  done
}

# Datalad
#------------------------------------------------
source <(datalad shell-completion) 2>/dev/null || true

alias dl-push="datalad push --to warehouse && datalad push --to origin"


# Tmux / Tmuxinator
#------------------------------------------------
function ktr() {
    printf "Do you want to kill the tmux session? [y/n] "
    read choice
    [[ "$choice" == "y" ]] && tmux kill-session
}

# GPG
#------------------------------------------------
alias gpg-restart='killall gpg-agent && sleep 1 && gpg-connect-agent /bye'

alias gpg-start='echo "Starting GPG" | gpg --clearsign'


# Terminal setup
#------------------------------------------------

# Zoxide
eval "$(zoxide init bash)"

# System setup
#------------------------------------------------

# nvitop exporter
if command -v nvidia-smi &> /dev/null; then
  if [[ -o login ]]; then
    bash ~/yadm/scripts/nvitop-exporter.sh
  fi
fi

##################################################
# Computer Specific
##################################################

# After loading all configurations, then run the computer specific config
source ~/.config/shell/computer_specific


#################################################
# MIT License                                   #
#                                               #
# Copyright Â© 2022-2025 Pranav Kumar Mishra     #
#################################################
